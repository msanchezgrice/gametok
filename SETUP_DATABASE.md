# Database Setup Instructions

## Apply the Migration to Supabase

1. **Go to your Supabase Dashboard**
   - Visit: https://supabase.com/dashboard/project/zpthvazjsiagqadifzmh/sql/new

2. **Run the Migration SQL**
   Copy and paste this entire SQL block into the SQL editor and click "Run":

```sql
-- Ensure session_events table exists
CREATE TABLE IF NOT EXISTS public.session_events (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  session_id UUID NOT NULL,
  event_type TEXT NOT NULL,
  payload JSONB NOT NULL DEFAULT '{}',
  occurred_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create index
CREATE INDEX IF NOT EXISTS idx_session_events_session ON public.session_events (session_id);

-- Enable RLS
ALTER TABLE public.session_events ENABLE ROW LEVEL SECURITY;

-- Drop and recreate policies
DROP POLICY IF EXISTS "Service role manages session events" ON public.session_events;
DROP POLICY IF EXISTS "Users read own session events" ON public.session_events;

-- Allow service role full access
CREATE POLICY "Service role manages session events"
  ON public.session_events FOR ALL
  USING (true)
  WITH CHECK (true);

-- Fix game_sessions table RLS
ALTER TABLE public.game_sessions ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Anyone can create sessions" ON public.game_sessions;
DROP POLICY IF EXISTS "Service role manages sessions" ON public.game_sessions;
DROP POLICY IF EXISTS "Users read own sessions" ON public.game_sessions;
DROP POLICY IF EXISTS "Anyone can update sessions" ON public.game_sessions;
DROP POLICY IF EXISTS "Anyone can read sessions" ON public.game_sessions;

-- Allow anyone to create sessions
CREATE POLICY "Anyone can create sessions"
  ON public.game_sessions FOR INSERT
  WITH CHECK (true);

-- Allow anyone to update their sessions
CREATE POLICY "Anyone can update sessions"
  ON public.game_sessions FOR UPDATE
  USING (true)
  WITH CHECK (true);

-- Allow service role full access
CREATE POLICY "Service role manages sessions"
  ON public.game_sessions FOR ALL
  USING (true)
  WITH CHECK (true);

-- Allow anyone to read sessions
CREATE POLICY "Anyone can read sessions"
  ON public.game_sessions FOR SELECT
  USING (true);
```

3. **Verify the Tables**
   After running the migration, verify the tables exist:
   - Go to Table Editor
   - Check that `session_events` table exists
   - Check that `game_sessions` table has the correct RLS policies

## What This Fixes

- ✅ Edge Functions will no longer return 500 errors
- ✅ Game sessions will be properly tracked in the database
- ✅ Events will be stored for analytics
- ✅ Anonymous users can play games and have their sessions tracked
- ✅ Likability scoring will have data to work with

## Vercel Environment Variables

Make sure these are set in your Vercel project:

```
NEXT_PUBLIC_SUPABASE_URL=https://zpthvazjsiagqadifzmh.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=<your-anon-key>
SUPABASE_SERVICE_ROLE=<your-service-role-key>
SUPABASE_URL=https://zpthvazjsiagqadifzmh.supabase.co
NEXT_PUBLIC_POSTHOG_KEY=<your-posthog-key>
NEXT_PUBLIC_POSTHOG_HOST=https://us.i.posthog.com
```

## Edge Functions

The Edge Functions have already been deployed with CORS fixes. They should start working once the database tables are created.

## Testing

1. Visit https://gametok-web.vercel.app
2. Click "Play" on a game
3. Toggle favorites (they'll be stored locally)
4. Check the Supabase dashboard to see if sessions are being created
5. Check the Edge Function logs to ensure no more 500 errors